<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>nginx | lana&#39;s home</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="vuepress 前端个人学习网站">
    
    <link rel="preload" href="/assets/css/0.styles.98530cad.css" as="style"><link rel="preload" href="/assets/js/app.a4743452.js" as="script"><link rel="preload" href="/assets/js/2.b72805e3.js" as="script"><link rel="preload" href="/assets/js/41.649b9d9b.js" as="script"><link rel="prefetch" href="/assets/js/10.97c6631e.js"><link rel="prefetch" href="/assets/js/100.ddd238ad.js"><link rel="prefetch" href="/assets/js/101.acf46de3.js"><link rel="prefetch" href="/assets/js/102.7ecc34c5.js"><link rel="prefetch" href="/assets/js/103.9abec0c7.js"><link rel="prefetch" href="/assets/js/104.99a0bd64.js"><link rel="prefetch" href="/assets/js/105.5bd4279e.js"><link rel="prefetch" href="/assets/js/106.4a1a1e6d.js"><link rel="prefetch" href="/assets/js/107.53190e25.js"><link rel="prefetch" href="/assets/js/108.afb416d9.js"><link rel="prefetch" href="/assets/js/109.9c89f8cf.js"><link rel="prefetch" href="/assets/js/11.efe147a8.js"><link rel="prefetch" href="/assets/js/110.77f01a7c.js"><link rel="prefetch" href="/assets/js/111.f8ccec3a.js"><link rel="prefetch" href="/assets/js/112.a1b70a36.js"><link rel="prefetch" href="/assets/js/113.f74d3176.js"><link rel="prefetch" href="/assets/js/114.9f4f70ac.js"><link rel="prefetch" href="/assets/js/115.3e915f82.js"><link rel="prefetch" href="/assets/js/116.21d4d9f8.js"><link rel="prefetch" href="/assets/js/117.ed1ac975.js"><link rel="prefetch" href="/assets/js/118.b60ec45f.js"><link rel="prefetch" href="/assets/js/119.a28f9722.js"><link rel="prefetch" href="/assets/js/12.f8166b62.js"><link rel="prefetch" href="/assets/js/120.5f45ba33.js"><link rel="prefetch" href="/assets/js/121.e2c73c6e.js"><link rel="prefetch" href="/assets/js/122.bea0d35f.js"><link rel="prefetch" href="/assets/js/123.4918a056.js"><link rel="prefetch" href="/assets/js/124.e9d5fd6b.js"><link rel="prefetch" href="/assets/js/125.378cd9ad.js"><link rel="prefetch" href="/assets/js/126.785be7e4.js"><link rel="prefetch" href="/assets/js/127.2dfe1120.js"><link rel="prefetch" href="/assets/js/128.0eeadbcb.js"><link rel="prefetch" href="/assets/js/129.ffd3ffd2.js"><link rel="prefetch" href="/assets/js/13.669aa6cb.js"><link rel="prefetch" href="/assets/js/130.e3caaa90.js"><link rel="prefetch" href="/assets/js/131.8914dd22.js"><link rel="prefetch" href="/assets/js/132.0ae37932.js"><link rel="prefetch" href="/assets/js/133.e989899b.js"><link rel="prefetch" href="/assets/js/134.ea062f20.js"><link rel="prefetch" href="/assets/js/135.6c137b49.js"><link rel="prefetch" href="/assets/js/14.c9aa70a1.js"><link rel="prefetch" href="/assets/js/15.3d05e5f2.js"><link rel="prefetch" href="/assets/js/16.360281d8.js"><link rel="prefetch" href="/assets/js/17.ff7cabb3.js"><link rel="prefetch" href="/assets/js/18.be16eeed.js"><link rel="prefetch" href="/assets/js/19.81b3a31e.js"><link rel="prefetch" href="/assets/js/20.472bc449.js"><link rel="prefetch" href="/assets/js/21.86395f2b.js"><link rel="prefetch" href="/assets/js/22.6c69ed50.js"><link rel="prefetch" href="/assets/js/23.2f198631.js"><link rel="prefetch" href="/assets/js/24.748c9bc2.js"><link rel="prefetch" href="/assets/js/25.c5065323.js"><link rel="prefetch" href="/assets/js/26.61d441a1.js"><link rel="prefetch" href="/assets/js/27.bfd0a986.js"><link rel="prefetch" href="/assets/js/28.bafeb054.js"><link rel="prefetch" href="/assets/js/29.0d2a1bfd.js"><link rel="prefetch" href="/assets/js/3.7f8809fd.js"><link rel="prefetch" href="/assets/js/30.8bb40757.js"><link rel="prefetch" href="/assets/js/31.eac619f5.js"><link rel="prefetch" href="/assets/js/32.04c63c5c.js"><link rel="prefetch" href="/assets/js/33.ae09c55e.js"><link rel="prefetch" href="/assets/js/34.1145a6f4.js"><link rel="prefetch" href="/assets/js/35.feb9083f.js"><link rel="prefetch" href="/assets/js/36.a586ce8a.js"><link rel="prefetch" href="/assets/js/37.c61e20e9.js"><link rel="prefetch" href="/assets/js/38.991c3427.js"><link rel="prefetch" href="/assets/js/39.23356a49.js"><link rel="prefetch" href="/assets/js/4.6819ae80.js"><link rel="prefetch" href="/assets/js/40.a3ca9111.js"><link rel="prefetch" href="/assets/js/42.fde8ad7b.js"><link rel="prefetch" href="/assets/js/43.2d876a7c.js"><link rel="prefetch" href="/assets/js/44.64c20de7.js"><link rel="prefetch" href="/assets/js/45.a901a632.js"><link rel="prefetch" href="/assets/js/46.4ac83b64.js"><link rel="prefetch" href="/assets/js/47.2b45c49a.js"><link rel="prefetch" href="/assets/js/48.2bc12623.js"><link rel="prefetch" href="/assets/js/49.52a95dcd.js"><link rel="prefetch" href="/assets/js/5.20de2bc4.js"><link rel="prefetch" href="/assets/js/50.f445c922.js"><link rel="prefetch" href="/assets/js/51.07570e18.js"><link rel="prefetch" href="/assets/js/52.cf21a2b8.js"><link rel="prefetch" href="/assets/js/53.77792ddd.js"><link rel="prefetch" href="/assets/js/54.f19c487a.js"><link rel="prefetch" href="/assets/js/55.7fb0d05b.js"><link rel="prefetch" href="/assets/js/56.62fd0b66.js"><link rel="prefetch" href="/assets/js/57.1d6b0809.js"><link rel="prefetch" href="/assets/js/58.1aed920b.js"><link rel="prefetch" href="/assets/js/59.c2ab9dbe.js"><link rel="prefetch" href="/assets/js/6.e9784f3e.js"><link rel="prefetch" href="/assets/js/60.f4e387a9.js"><link rel="prefetch" href="/assets/js/61.735cc066.js"><link rel="prefetch" href="/assets/js/62.312489f2.js"><link rel="prefetch" href="/assets/js/63.dd2a2d4e.js"><link rel="prefetch" href="/assets/js/64.67dfd073.js"><link rel="prefetch" href="/assets/js/65.c2c22de8.js"><link rel="prefetch" href="/assets/js/66.7ea30a4b.js"><link rel="prefetch" href="/assets/js/67.6913be8c.js"><link rel="prefetch" href="/assets/js/68.b743701c.js"><link rel="prefetch" href="/assets/js/69.088259eb.js"><link rel="prefetch" href="/assets/js/7.80ddef84.js"><link rel="prefetch" href="/assets/js/70.10e2101b.js"><link rel="prefetch" href="/assets/js/71.11121db3.js"><link rel="prefetch" href="/assets/js/72.38811b9b.js"><link rel="prefetch" href="/assets/js/73.b5030976.js"><link rel="prefetch" href="/assets/js/74.d218c8d5.js"><link rel="prefetch" href="/assets/js/75.89c8d415.js"><link rel="prefetch" href="/assets/js/76.998def7e.js"><link rel="prefetch" href="/assets/js/77.6cff4b72.js"><link rel="prefetch" href="/assets/js/78.45b13ba4.js"><link rel="prefetch" href="/assets/js/79.50d5b3d0.js"><link rel="prefetch" href="/assets/js/8.4ebeab97.js"><link rel="prefetch" href="/assets/js/80.e38925eb.js"><link rel="prefetch" href="/assets/js/81.c712e794.js"><link rel="prefetch" href="/assets/js/82.f4018c72.js"><link rel="prefetch" href="/assets/js/83.878fb392.js"><link rel="prefetch" href="/assets/js/84.7ddaa3ca.js"><link rel="prefetch" href="/assets/js/85.06c8fa8b.js"><link rel="prefetch" href="/assets/js/86.b889a2e3.js"><link rel="prefetch" href="/assets/js/87.2f3171f1.js"><link rel="prefetch" href="/assets/js/88.1b0c6839.js"><link rel="prefetch" href="/assets/js/89.293034a1.js"><link rel="prefetch" href="/assets/js/9.07e73bd0.js"><link rel="prefetch" href="/assets/js/90.cdd9df6a.js"><link rel="prefetch" href="/assets/js/91.e53063a5.js"><link rel="prefetch" href="/assets/js/92.0a41da3b.js"><link rel="prefetch" href="/assets/js/93.83c37c7e.js"><link rel="prefetch" href="/assets/js/94.14eea0cb.js"><link rel="prefetch" href="/assets/js/95.18279896.js"><link rel="prefetch" href="/assets/js/96.e06d8e4e.js"><link rel="prefetch" href="/assets/js/97.2b60994e.js"><link rel="prefetch" href="/assets/js/98.28ad17a5.js"><link rel="prefetch" href="/assets/js/99.2abf3996.js">
    <link rel="stylesheet" href="/assets/css/0.styles.98530cad.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="lana's home" class="logo"> <span class="site-name can-hide">lana's home</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="随笔" class="dropdown-title"><span class="title">随笔</span> <span class="arrow down"></span></button> <button type="button" aria-label="随笔" class="mobile-dropdown-title"><span class="title">随笔</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          前端
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/front/html5/" class="nav-link">
  Html5
</a></li><li class="dropdown-subitem"><a href="/front/css/" class="nav-link">
  Css
</a></li><li class="dropdown-subitem"><a href="/front/js/" class="nav-link">
  js
</a></li></ul></li><li class="dropdown-item"><h4>
          后端
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/backend/nodejs/" class="nav-link">
  Nodejs
</a></li><li class="dropdown-subitem"><a href="/backend/koa/" class="nav-link">
  Koa
</a></li><li class="dropdown-subitem"><a href="/backend/mongodb/" class="nav-link">
  Mongodb
</a></li></ul></li><li class="dropdown-item"><h4>
          服务器
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/backend/nginx/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Nginx
</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/guide/guide.html" class="nav-link">
  指引
</a></div><div class="nav-item"><a href="https://gitee.com/lanasine" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/cats1/vuepresshome" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="随笔" class="dropdown-title"><span class="title">随笔</span> <span class="arrow down"></span></button> <button type="button" aria-label="随笔" class="mobile-dropdown-title"><span class="title">随笔</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          前端
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/front/html5/" class="nav-link">
  Html5
</a></li><li class="dropdown-subitem"><a href="/front/css/" class="nav-link">
  Css
</a></li><li class="dropdown-subitem"><a href="/front/js/" class="nav-link">
  js
</a></li></ul></li><li class="dropdown-item"><h4>
          后端
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/backend/nodejs/" class="nav-link">
  Nodejs
</a></li><li class="dropdown-subitem"><a href="/backend/koa/" class="nav-link">
  Koa
</a></li><li class="dropdown-subitem"><a href="/backend/mongodb/" class="nav-link">
  Mongodb
</a></li></ul></li><li class="dropdown-item"><h4>
          服务器
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/backend/nginx/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Nginx
</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/guide/guide.html" class="nav-link">
  指引
</a></div><div class="nav-item"><a href="https://gitee.com/lanasine" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/cats1/vuepresshome" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Backend</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Api</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Docker</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Koa</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Mongodb</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>Nginx</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/backend/nginx/" aria-current="page" class="active sidebar-link">nginx</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/backend/nginx/#搭建静态站点" class="sidebar-link">搭建静态站点</a></li><li class="sidebar-sub-header"><a href="/backend/nginx/#搭建文件服务器" class="sidebar-link">搭建文件服务器</a></li><li class="sidebar-sub-header"><a href="/backend/nginx/#解决跨域" class="sidebar-link">解决跨域</a></li><li class="sidebar-sub-header"><a href="/backend/nginx/#动态匹配-请求过滤" class="sidebar-link">动态匹配（请求过滤）</a></li><li class="sidebar-sub-header"><a href="/backend/nginx/#反向代理" class="sidebar-link">反向代理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/backend/nginx/#反向代理解决跨域" class="sidebar-link">反向代理解决跨域</a></li><li class="sidebar-sub-header"><a href="/backend/nginx/#实例" class="sidebar-link">实例</a></li></ul></li><li class="sidebar-sub-header"><a href="/backend/nginx/#配置gzip" class="sidebar-link">配置Gzip</a></li><li class="sidebar-sub-header"><a href="/backend/nginx/#负载均衡" class="sidebar-link">负载均衡</a></li><li class="sidebar-sub-header"><a href="/backend/nginx/#静态加载文件" class="sidebar-link">静态加载文件</a></li><li class="sidebar-sub-header"><a href="/backend/nginx/#https配置" class="sidebar-link">https配置</a></li><li class="sidebar-sub-header"><a href="/backend/nginx/#优化配置" class="sidebar-link">优化配置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/backend/nginx/#打包压缩文件" class="sidebar-link">打包压缩文件</a></li><li class="sidebar-sub-header"><a href="/backend/nginx/#worker机制" class="sidebar-link">worker机制</a></li></ul></li><li class="sidebar-sub-header"><a href="/backend/nginx/#nginx命令" class="sidebar-link">nginx命令</a></li></ul></li><li><a href="/backend/nginx/docker.html" class="sidebar-link">docker</a></li><li><a href="/backend/nginx/linux.html" class="sidebar-link">linux</a></li><li><a href="/backend/nginx/nginx-nodejs-api.html" class="sidebar-link">nginx转发nodejs的接口</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Nodejs</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Redis</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Front</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Guide</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="nginx"><a href="#nginx" class="header-anchor">#</a> nginx</h1> <p>Nginx 是一个高性能的HTTP和反向代理服务器，同时也是一个 IMAP/POP3/SMTP 代理服务器。</p> <p>Nginx（engine x）是一款轻量级的 Web 服务器 、反向代理服务器及电子邮件（IMAP/POP3）代理服务器。</p> <p>其特点是占有内存少，并发能力强。</p> <p>常见场景：</p> <ul><li>静态资源服务器</li> <li>动态匹配</li> <li>反向代理</li> <li>Gzip 压缩</li> <li>负载均衡</li></ul> <blockquote><p>Nginx 安装目录下的<code>nginx.conf</code>就是Nginx全局的配置文件，我们主要修改这里的内容。<code>nginx.conf.default</code>作为配置文件的备份。</p></blockquote> <div class="language- extra-class"><pre><code># 设置工作进程的数量
worker_processes  1;
# 处理连接
events {
    # 设置连接数
    worker_connections  1024;
}
http {
	#文件拓展名查找集合
    include       mime.types;
    # 当查找不到对应类型的时候默认值
    default_type  application/octet-stream;
    # 日志格式，定义别名为 main
    #log_format  main  '$remote_addr - $remote_user [$time_local] &quot;$request&quot; '
    #                  '$status $body_bytes_sent &quot;$http_referer&quot; '
    #                  '&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;';

    # 指定日志输入目录
    #access_log  logs/access.log  main;

    # 调用 sendfile 系统传输文件
    sendfile        on;
    #tcp_nopush     on;

    # 客户端与服务器连接超时时间，超时自动断开
    #keepalive_timeout  0;
    keepalive_timeout  65;

    # 开启gizip 压缩
    #gzip  on;

    # 虚拟主机
    server {
        listen       8080;#监听的端口
        server_name  localhost;

        #charset koi8-r;

        #access_log  logs/host.access.log  main;

        # 路由
        location / { #location表示路径匹配
                root   html;#root表示寻找文件夹的路径
                index  index.html index.htm;#index表示在root已经定义的文件夹下面的具体文件
            }
        
    }

    # 引入其他的配置文件
    include servers/*;
 }
</code></pre></div><h2 id="搭建静态站点"><a href="#搭建静态站点" class="header-anchor">#</a> 搭建静态站点</h2> <div class="language- line-numbers-mode"><pre class="language-text"><code># 虚拟主机server块
server {
    # 端口
    listen   8080;
    # 匹配请求中的host值
    server_name  localhost;
    
    # 监听请求路径
    location / {
        # 查找目录
        root /source;
        # 默认查找
        index index.html index.htm;
    }
}
#另一种写法
server {
    server_name localhost;
    listen 8080;
    root /home;

    location / {
        #try_files是表示寻找文件 $uri表示root已经定义的变量
        #下面用来两个$uri是因为有时候html会引入其他css或者js文件，第一个$uri表示在当前文件夹下面寻找，第二个$uri表示精确找到html文件
        try_files $uri $uri/ /index.html;
    }
}

作者：山黎
链接：https://juejin.cn/post/6844904090195984397
来源：掘金
著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。
worker_processes  1;

events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;

    gzip on;
    gzip_types text/plain application/x-javascript text/css application/xml text/javascript application/javascript image/jpeg image/gif image/png;
    gzip_vary on;

    server {
        listen       80;
        server_name  static.zp.cn;

        location / {
            root /app/dist;
            index index.html;
            #转发任何请求到 index.html
        }
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div><p>相关字段</p> <ul><li><p><code>server</code>  配置虚拟主机的相关参数，可以有多个</p></li> <li><p><code>server_name</code> 通过请求中的host值 找到对应的虚拟主机的配置</p></li> <li><p><code>location</code>  配置请求路由，处理相关页面情况</p> <p><strong>location用来匹配url地址，语法是：<code>location [ = | ~ | ~\* | ^~ ] uri{}</code> 这里会有四种匹配规则:</strong></p> <ul><li><code>=</code> 该装饰符会精确匹配并终止搜索</li> <li><code>~</code> 该装饰符使用区分大小写的正则表达式匹配</li> <li><code>~*</code> 该装饰符使用不区分大小写的正则表达式匹配</li> <li><code>^~</code> 该装饰符使用在不含正则表达式的uri前，当匹配成功以后，将不会再执行其他的正则表达式的location块</li></ul></li> <li><p><code>root</code> 查找资源的路径</p></li></ul> <p>配置完成后执行 <code>nginx -t</code> 看是否有错误，如果看到的是下面这种就是成功了</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf test is successful
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>然后执行<code>nginx -s reload</code> 更新Nginx配置文件</p> <p>这时候打开浏览器  输入 localhost:8080  应该就能看到你的页面了</p> <blockquote><p><code>nginx -t</code> 检查配置文件是否有语法错误
<code>nginx -s reload</code> 向主进程发送信号，重新加载配置文件
<code>nginx -s stop</code> 快速关闭
<code>nginx -s quit</code> 等待工作进程处理完成后关闭</p></blockquote> <h2 id="搭建文件服务器"><a href="#搭建文件服务器" class="header-anchor">#</a> <strong>搭建文件服务器</strong></h2> <p>有时候，团队需要归档一些数据或资料，那么文件服务器必不可少。使用 Nginx 可以非常快速便捷的搭建一个简易的文件服务。</p> <p>Nginx 中的配置要点：</p> <ul><li>将 autoindex 开启可以显示目录，默认不开启。</li> <li>将 autoindex_exact_size 开启可以显示文件的大小。</li> <li>将 autoindex_localtime 开启可以显示文件的修改时间。</li> <li>root 用来设置开放为文件服务的根路径。</li> <li>charset 设置为 charset utf-8，gbk，可以避免中文乱码问题。</li></ul> <p>一个最简化的配置如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>autoindex on;# 显示目录
autoindex_exact_size on;# 显示文件大小
autoindex_localtime on;# 显示文件时间

server {
    charset      utf-8,gbk; # windows 服务器下设置后，依然乱码，暂时无解
    listen       9050 default_server;
    listen       [::]:9050 default_server;
    server_name  _;
    root         /share/fs;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="解决跨域"><a href="#解决跨域" class="header-anchor">#</a> <strong>解决跨域</strong></h2> <p>Web 领域开发中，经常采用前后端分离模式。这种模式下，前端和后端分别是独立的 Web 应用程序，例如：后端是 Java 程序，前端是 React 或 Vue 应用。</p> <p>各自独立的 web app 在互相访问时，势必存在跨域问题。解决跨域问题一般有两种思路：</p> <ul><li>**CORS，**在后端服务器设置 HTTP 响应头，把你需要允许访问的域名加入 Access-Control-Allow-Origin 中。</li> <li>**jsonp，**把后端根据请求，构造 json 数据，并返回，前端用 jsonp 跨域。</li></ul> <p>这两种思路，本文不展开讨论。需要说明的是，Nginx 根据第一种思路，也提供了一种解决跨域的解决方案。</p> <p>举例：www.helloworld.com 网站是由一个前端 app ，一个后端 app 组成的。前端端口号为 9000， 后端端口号为 8080。</p> <p>前端和后端如果使用 HTTP 进行交互时，请求会被拒绝，因为存在跨域问题。来看看，Nginx 是怎么解决的吧。</p> <p>首先，在 enable-cors.conf 文件中设置 cors：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code># allow origin list
set $ACAO '*';

# set single origin
if ($http_origin ~* (www.helloworld.com)$) {
  set $ACAO $http_origin;
}

if ($cors = &quot;trueget&quot;) {
    add_header 'Access-Control-Allow-Origin' &quot;$http_origin&quot;;
    add_header 'Access-Control-Allow-Credentials' 'true';
    add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
    add_header 'Access-Control-Allow-Headers' 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';
}

if ($request_method = 'OPTIONS') {
  set $cors &quot;${cors}options&quot;;
}

if ($request_method = 'GET') {
  set $cors &quot;${cors}get&quot;;
}

if ($request_method = 'POST') {
  set $cors &quot;${cors}post&quot;;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>接下来，在你的服务器中 include enable-cors.conf 来引入跨域配置：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code># ----------------------------------------------------
# 此文件为项目 nginx 配置片段
# 可以直接在 nginx config 中 include（推荐）
# 或者 copy 到现有 nginx 中，自行配置
# www.helloworld.com 域名需配合 dns hosts 进行配置
# 其中，api 开启了 cors，需配合本目录下另一份配置文件
# ----------------------------------------------------
upstream front_server{
  server www.helloworld.com:9000;
}
upstream api_server{
  server www.helloworld.com:8080;
}

server {
  listen       80;
  server_name  www.helloworld.com;

  location ~ ^/api/ {
    include enable-cors.conf;
    proxy_pass http://api_server;
    rewrite &quot;^/api/(.*)$&quot; /$1 break;
  }

  location ~ ^/ {
    proxy_pass http://front_server;
  }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>到此，就完成了。</p> <h2 id="动态匹配-请求过滤"><a href="#动态匹配-请求过滤" class="header-anchor">#</a> 动态匹配（请求过滤）</h2> <blockquote><p>通常在开发环境或者测试环境的时候呢我们修改了代码，因为浏览器缓存，可能不会生效，需要手动清除缓存，才能看到修改后的效果，这里我们做一个配置让浏览器不缓存相关的资源。</p></blockquote> <div class="language- line-numbers-mode"><pre class="language-text"><code>location ~* \.(js|css|png|jpg|gif)$ {
    add_header Cache-Control no-store;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><code>~* \.(js|css|png|jpg|gif)$</code> 是匹配以相关文件类型然后单独处理。 <code>add_header</code> 是给请求的响应加上一个头信息<code>Cache-Control no-store</code>，告知浏览器禁用缓存，每次都从服务器获取 效果如下：</p> <p><img src="https://user-gold-cdn.xitu.io/2019/4/8/169fc1a508ab1aba?imageView2/0/w/1280/h/960/ignore-error/1" alt="Cache-Contro"></p> <h4 id="匹配规则"><a href="#匹配规则" class="header-anchor">#</a> 匹配规则</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>location = / {
    [ configuration A ]
}

location / {
    [ configuration B ]
}

location /documents/ {
    [ configuration C ]
}

location ^~ /images/ {
    [ configuration D ]
}

location ~* \.(gif|jpg|jpeg)$ {
    [ configuration E ]
}

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><ul><li><code>=</code> 表示精确匹配。只有请求的url路径与后面的字符串完全相等时，才会命中（优先级最高）。</li> <li><code>^~</code> 表示如果该符号后面的字符是最佳匹配，采用该规则，不再进行后续的查找。</li> <li><code>~</code> 表示该规则是使用正则定义的，区分大小写。</li> <li><code>~*</code> 表示该规则是使用正则定义的，不区分大小写。</li></ul> <p>当然我们还可以通过状态码来过滤请求就像这样</p> <div class="language- line-numbers-mode"><pre class="language-text"><code># 通过状态码，返回指定的错误页面
error_page 500 502 503 504 /50x.html;
location = /50x.html {
    root /source/error_page;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="反向代理"><a href="#反向代理" class="header-anchor">#</a> 反向代理</h2> <p>反向代理（Reverse Proxy）方式是指以代理服务器来接受 internet 上的连接请求，然后将请求转发给内部网络上的服务器，并将从服务器上得到的结果返回给 internet 上请求连接的客户端。</p> <p>此时代理服务器对外就表现为一个反向代理服务器，如下图：</p> <img src="https://mmbiz.qpic.cn/mmbiz_png/A1HKVXsfHNmfExVw08cor0GwprdeqA8Rax40MniaXLoaiahjDqJmJW6qasgnBzGXRHU3J9aQRxak3mkWY782Ubug/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片" style="zoom:80%;"> <h3 id="反向代理解决跨域"><a href="#反向代理解决跨域" class="header-anchor">#</a> 反向代理解决跨域</h3> <blockquote><p>因为浏览器的<a href="https://developer.mozilla.org/zh-CN/docs/Web/Security/Same-origin_policy" target="_blank" rel="noopener noreferrer">同源策略<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，当前端域名与后端域名不一致的时候导致请求失败。我们可以通过配置Nginx反向代理来解决。</p></blockquote> <div class="language- line-numbers-mode"><pre class="language-text"><code>location /api {   
    # 请求host传给后端
    proxy_set_header Host $http_host;
    # 请求ip 传给后端
    proxy_set_header X-Real-IP $remote_addr;
    # 请求协议传给后端
    proxy_set_header X-Scheme $scheme;
    #后台服务通过x-forward-for知道用户的实际IP
    proxy_set_header X-Forward-For $proxy_add_x_forward_for;
    # 路径重写
    rewrite  /api/(.*)  /$1  break;
    # 代理服务器
    proxy_pass http://localhost:9000;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><ul><li>拦截路径<code>/api</code>, 可以通过正则匹配。</li> <li><code>proxy_set_header</code> 允许重新定义或添加字段传递给代理服务器的请求头。</li> <li><code>$http_host</code>、<code>$remote_addr</code>、<code>$scheme</code> 为Nginx内置变量。</li> <li><code>rewrite</code> 根据rewrite后的请求URI，将路径重写，如：接口路径为 <code>/user</code>, 我们可以请求 <code>/api/user</code>。（为什么需要重写uri？因为在使用Nginx做反向代理的时候，需要匹配到跨域的接口再做转发，为了方便匹配，会人为的在原接口中添加一段路径（或标示， 如例子中的<code>api</code>），因此需要在匹配之后、转发之前把添加的那段去掉，因此需要rewrite。）</li> <li><code>break</code> 继续本次请求后面的处理 ,停止匹配下面的<code>location</code>。需要注意的是与之类似的<code>last</code>执行过程则是停止当前这个请求，并根据rewrite匹配的规则重新发起一个请求，从上到下依次匹配<code>location</code>后面的规则。</li> <li><code>proxy_pass</code> 代理服务器。</li></ul> <blockquote><p>原理：Nginx拦截到相关匹配规则, Nginx再将请求转发到<code>http://localhost:9000</code>，Nginx得到请求后再响应到前端，可以直接请求<code>/api/user</code>完成请求。</p></blockquote> <h3 id="实例"><a href="#实例" class="header-anchor">#</a> 实例</h3> <p>我们先实现一个小目标：不考虑复杂的配置，仅仅是完成一个 HTTP 反向代理。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>#设定实际的服务器列表
upstream zp_server1{
  server 127.0.0.1:8089;
}
#反向代理的路径（和 upstream 绑定），location 后面设置映射的路径
location / {
  proxy_pass http://zp_server1;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>HTTPS反向代理</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>网站有多个 webapp 的配置</strong></p> <p>当一个网站功能越来越丰富时，往往需要将一些功能相对独立的模块剥离出来，独立维护。这样的话，通常，会有多个 webapp。</p> <p>**举个例子：**假如 www.helloworld.com 站点有好几个 webapp，finance（金融）、product（产品）、admin（用户中心）。</p> <p>访问这些应用的方式通过上下文（context）来进行区分：</p> <ul><li>www.helloworld.com/finance/</li> <li>www.helloworld.com/product/</li> <li>www.helloworld.com/admin/</li></ul> <p>我们知道，HTTP 的默认端口号是 80，如果在一台服务器上同时启动这 3 个 webapp 应用，都用 80 端口，肯定是不成的。所以，这三个应用需要分别绑定不同的端口号。</p> <p>那么，问题来了，用户在实际访问 www.helloworld.com 站点时，访问不同 webapp，总不会还带着对应的端口号去访问吧。所以，你再次需要用到反向代理来做处理。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>http {
    #此处省略一些基本配置

    upstream product_server{
        server www.helloworld.com:8081;
    }

    upstream admin_server{
        server www.helloworld.com:8082;
    }

    upstream finance_server{
        server www.helloworld.com:8083;
    }

    server {
        #此处省略一些基本配置
        #默认指向product的server
        location / {
            proxy_pass http://product_server;
        }

        location /product/{
            proxy_pass http://product_server;
        }

        location /admin/ {
            proxy_pass http://admin_server;
        }

        location /finance/ {
            proxy_pass http://finance_server;
        }
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><h2 id="配置gzip"><a href="#配置gzip" class="header-anchor">#</a> 配置Gzip</h2> <p>开发过程中难免用到一些成熟的框架，或者插件，这些外部的依赖，有时候体积比较大，导致页面响应缓慢，我们可以用打包工具(webpack, rollup)，将代码进行压缩，以缩小代码体积。 开启Nginx Gzip压缩功能。需要注意的是 Gzip 压缩功能需要浏览器跟服务器都支持，即服务器压缩，浏览器解析。</p> <ul><li><p>查看浏览器支持情况，确定 <em>请求头</em> 中的<code>Accept-Encoding</code>字段</p> <p><img src="https://user-gold-cdn.xitu.io/2019/4/11/16a0a18ea2c217b7?imageView2/0/w/1280/h/960/ignore-error/1" alt="gzip浏览器支持"></p></li> <li><p>确定浏览器支持，我们就可以在Nginx中配置</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server {
    # 开启gzip 压缩
    gzip on;
    # 设置gzip所需的http协议最低版本 （HTTP/1.1, HTTP/1.0）
    gzip_http_version 1.1;
    # 设置压缩级别，压缩级别越高压缩时间越长  （1-9）
    gzip_comp_level 4;
    # 设置压缩的最小字节数， 页面Content-Length获取
    gzip_min_length 1000;
    # 设置压缩文件的类型  （text/html)
    gzip_types text/plain application/javascript text/css;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div></li> <li><p>查看配置是否生效，查看 <em>响应头</em> 中的<code>Content-Encoding</code>字段，值为 <code>gzip</code></p> <p><img src="https://user-gold-cdn.xitu.io/2019/4/11/16a0a18ea2a3f84b?imageView2/0/w/1280/h/960/ignore-error/1" alt="gzip生效"></p></li></ul> <h2 id="负载均衡"><a href="#负载均衡" class="header-anchor">#</a> 负载均衡</h2> <p>代理仅仅指向一个服务器。但是，网站在实际运营过程中，大部分都是以集群的方式运行，这时需要使用负载均衡来分流。Nginx 也可以实现简单的负载均衡功能。</p> <img src="https://mmbiz.qpic.cn/mmbiz_png/A1HKVXsfHNmfExVw08cor0GwprdeqA8R4jtibgrYnXXZmZI2xVhXQyQCyvCWMtQDOtjOv2zrpGlkwcFd2VYqN8Q/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片" style="zoom:80%;"> <p>假设这样一个应用场景：将应用部署在 192.168.1.11:80、192.168.1.12:80、192.168.1.13:80 三台 Linux 环境的服务器上。网站域名叫  www.helloworld.com，公网 IP 为 192.168.1.11。</p> <p>顾名思义，负载均衡即是将负载分摊到不同的服务单元，既保证服务的可用性，又保证响应足够快，给用户很好的体验。</p> <p>负载均衡是Nginx 比较常用的一个功能，可优化资源利用率，最大化吞吐量，减少延迟，确保容错配置，将流量分配到多个后端服务器。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Syntax:	upstream name { ... }
Default: —
Context: stream
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>使用nginx实现负载均衡需要proxy模块和upstream模块搭配实现，upstream将启用一个新的配置区域，在该区域定义了一组上游服务器。</p> <p>这里举出常用的几种策略</p> <ul><li><p><strong>轮询</strong>（默认），请求过来后，Nginx 随机分配流量到任一服务器</p> <p>每个请求按照时间顺序分别分配到其他后台服务器，如果设置down则表示服务器暂时停机不作使用</p> <p>设置backup则表示其他所有非backup状态的主机在down或者忙的时候才会访问这个backup状态的主机</p> <p>设置max_fails表示最大失败数，超过次数则暂时停机</p> <p>设置fail_timeout表示如果请求受理失败，则暂停指定的多少秒以后重新发起请求</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>upstream myserver{
    server localhost:4001 down;
    server localhost:4002 max_fails=3 fail_timeout=20s;
    server localhost:4003 backup;
}

upstream bck_testing_01 {
  # 默认所有服务器权重为 1
  server 192.168.250.220:8080
  server 192.168.250.221:8080
  server 192.168.250.222:8080
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div></li> <li><p><code>weight=number</code> 设置服务器的权重，默认为1，权重大的会被优先分配。weight权重分配</p> <p>指定轮询几率，权重跟轮询几率成正比,用来解决服务器性能不均的问题</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>weight权重分配
upstream myserver{
    server localhost:4001 weight=3;
    server localhost:4002 weight=5;
    server localhost:4003 weight=3;
}
upstream bck_testing_01 {
  server 192.168.250.220:8080   weight=3
  server 192.168.250.221:8080              # default weight=1
  server 192.168.250.222:8080              # default weight=1
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div></li> <li><p><code>backup</code> 标记为备份服务器。当主服务器不可用时，将传递与备份服务器的连接。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>

upstream backend {
    server 127.0.0.1:3000 backup;
    server 127.0.0.1:3001;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li> <li><p><code>ip_hash</code> 保持会话，保证同一客户端始终访问一台服务器。</p> <p>每个请求按照ip的hash分配，即每个用户都固定使用一个后台服务器，用来解决session不同的问题</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>upstream myserver{
    ip_hash;
    server localhost:4001;
    server localhost:4002;
    server localhost:4003;
}

upstream backend {
    ip_hash;  
    server 127.0.0.1:3000 backup;
    server 127.0.0.1:3001;
}

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div></li> <li><p>普通 Hash</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>upstream bck_testing_01 {
  hash $request_uri;
  # with default weight for all (weight=1)
  server 192.168.250.220:8080
  server 192.168.250.221:8080
  server 192.168.250.222:8080
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></li> <li><p><code>least_conn</code> 加权最少连接，优先分配最少连接数的服务器，避免服务器超载请求过多。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>upstream bck_testing_01 {
  least_conn;

  server 192.168.250.220:8080   weight=3
  server 192.168.250.221:8080              # default weight=1
  server 192.168.250.222:8080              # default weight=1
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></li> <li><p>fair(第三方包，需要自己去下载配置)</p> <p>按后台服务器的响应时间来分配请求，响应时间少的优先分配</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>upstream myserver{
    server localhost:4001;
    server localhost:4002;
    server localhost:4003;
    fair;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>最后使用代理</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server{

    listen 80;
    server_name localhost;

    location / {
        proxy_pass http://myserver;
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div></li></ul> <p>当我们需要代理一个集群时候可以通过下面这种方式实现。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>http {
    upstream backend {
        server 127.0.0.1:3000;
        server 127.0.0.1:3001;
    }
    server {
        listen      9000;
        server_name localhost;
        
        location / {
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Scheme $scheme;
            
            proxy_pass backend; 
        }
    }
}
http {
     #设定 mime 类型，类型由 mime.type 文件定义
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    #设定日志格式
    access_log    /var/log/nginx/access.log;

    #设定负载均衡的服务器列表
    upstream load_balance_server {
        #weigth 参数表示权值，权值越高被分配到的几率越大
        server 192.168.1.11:80   weight=5;
        server 192.168.1.12:80   weight=1;
        server 192.168.1.13:80   weight=6;
    }

   #HTTP 服务器
   server {
        #侦听 80 端口
        listen       80;

        #定义使用 www.xx.com 访问
        server_name  www.helloworld.com;

        #对所有请求进行负载均衡请求
        location / {
            root        /root;                 #定义服务器的默认网站根目录位置
            index       index.html index.htm;  #定义首页索引文件的名称
            proxy_pass  http://load_balance_server ;#请求转向load_balance_server 定义的服务器列表

            #以下是一些反向代理的配置(可选择性配置)
            #proxy_redirect off;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            #后端的 Web 服务器可以通过 X-Forwarded-For 获取用户真实 IP
            proxy_set_header X-Forwarded-For $remote_addr;
            proxy_connect_timeout 90;          #Nginx 跟后端服务器连接超时时间（代理连接超时）
            proxy_send_timeout 90;             #后端服务器数据回传时间（代理发送超时）
            proxy_read_timeout 90;             #连接成功后，后端服务器响应时间（代理接收超时）
            proxy_buffer_size 4k;              #设置代理服务器（Nginx）保存用户头信息的缓冲区大小
            proxy_buffers 4 32k;               #proxy_buffers 缓冲区，网页平均在 32k 以下的话，这样设置
            proxy_busy_buffers_size 64k;       #高负荷下缓冲大小（proxy_buffers*2）
            proxy_temp_file_write_size 64k;    #设定缓存文件夹大小，大于这个值，将从 upstream 服务器传

            client_max_body_size 10m;          #允许客户端请求的最大单文件字节数
            client_body_buffer_size 128k;      #缓冲区代理缓冲用户端请求的最大字节数
        }
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br></div></div><h2 id="静态加载文件"><a href="#静态加载文件" class="header-anchor">#</a> 静态加载文件</h2> <p>在服务器的文件夹里偶尔会存放文件、图片，这个时候想要在本地直接查看文件但是又不想登录服务器去看，就需要用nginx去静态加载文件。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server{
    server_name localhost;
    listen 80;

    location /image/{
        autoindex on; #打开自动列表
        alias /home/image/; #将/image/映射到/home/image/文件夹
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="https配置"><a href="#https配置" class="header-anchor">#</a> https配置</h2> <p>https是基于http协议的，使用SSL或TLS进行加密处理数据、验证对方身份和数据完整性保护。</p> <ol><li>https里客户端(浏览器)向服务端发送信息，客户端用服务端的公钥加密，然后传输到服务端以后，服务端用私钥解密。</li> <li>服务端向客户端发送信息，服务端通过私钥加密，然后传输到客户端，客户端再用服务端的公钥解密。</li></ol> <p>一般是需要申请CA的https证书的。</p> <p>假设我已经申请证书成功了，证书分别是 /home/test.pem和/home/test.key，我的服务器备案网址是www.example.cn，现在开始配置nginx的https:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server {
       server_name localhost www.example.cn example.cn;
        listen 80;
        listen [::]:80; #配置https2的ipv6地址
        listen 443 ssl http2; #配置443端口监听https加密
        listen [::]:443 ssl http2;

        ssl_certificate  /home/test.pem;
        ssl_certificate_key /home/test.key;

        ssl_session_cache shared:SSL:10m;#配置共享会话缓存大小
        ssl_session_timeout 5m; #配置会话超时时间

        add_header X-xss-Protection 1;#防止xss攻击

        location / {
            root /home;
            index index.html;
        }
}

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h2 id="优化配置"><a href="#优化配置" class="header-anchor">#</a> 优化配置</h2> <h3 id="打包压缩文件"><a href="#打包压缩文件" class="header-anchor">#</a> 打包压缩文件</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>http{

    gzip on; #开启gzip压缩输出
    gzip_min_length 1k;#最小压缩文件大小
    gzip buffers 4 16k;#压缩缓冲区
    gzip_comp_level 9; #压缩的等级，数值为1-9的任意值，9是最慢但压缩比最大
    #压缩的文本类型
    gzip_types  text/plain application/javascript application/x-javascript text/css application/xml text/javascript application/x-httpd-php image/jpeg image/gif image/png;
    gzip_disable &quot;MSIE[1-6]\.&quot;; #IE6客户端以下禁用压缩
}

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="worker机制"><a href="#worker机制" class="header-anchor">#</a> worker机制</h3> <p>每个worker就是一个独立的进程，但每个进程里只有一个主线程，通过异步非堵塞的方式来方式来处理请求，每个worker的线程可以发挥服务器的一个cpu，所以设置worker数和服务器的cpu数相等是最合适的，再设置worker_connection连接数，表示最大的并发数。假如每次服务器要占三个连接，那么最大并发量是worker_processes * woker_connection/3，假如设置了反向代理服务器，则最大并发量是worker_processes * woker_connection/6，因为每个并发会建立前端和后台的连接，占用两个连接。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>http{
    worker_processes 4;
    worker_cpu_affinity 0001 0010 0100 1000; #分配cpu块

    pid logs/nginx.pid; #进程文件

    worker_rlimit_nofile 1024; #一个nginx进程最多打开多少文件

    events{
        use epoll;#使用多路复用方式，提高nginx性能
        worker_connection 1024; #单个process的最大并发量
    }

}

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h2 id="nginx命令"><a href="#nginx命令" class="header-anchor">#</a> nginx命令</h2> <p>详细安装方法请参考：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>https://github.com/dunwu/nginx-tutorial/blob/master/docs/nginx-ops.md
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Nginx 的使用比较简单，就是几条命令。</p> <p>常用到的命令如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>nginx -s stop       快速关闭 Nginx，可能不保存相关信息，并迅速终止 Web 服务。
nginx -s quit       平稳关闭 Nginx，保存相关信息，有安排的结束 Web 服务。
nginx -s reload     因改变了 Nginx 相关配置，需要重新加载配置而重载。
nginx -s reopen     重新打开日志文件。
nginx -c filename   为 Nginx 指定一个配置文件，来代替缺省的。
nginx -t            不运行，仅仅测试配置文件。Nginx 将检查配置文件的语法的正确性，并尝试打开配置文件中所引用到的文件。
nginx -v            显示 Nginx 的版本。
nginx -V            显示 Nginx 的版本，编译器版本和配置参数。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>如果不想每次都敲命令，可以在 Nginx 安装目录下新添一个启动批处理文件 startup.bat，双击即可运行。</p> <p>内容如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>@echo off
rem 如果启动前已经启动 Nginx 并记录下 pid 文件，会 kill 指定进程
nginx.exe -s stop

rem 测试配置文件语法正确性
nginx.exe -t -c conf/nginx.conf

rem 显示版本信息
nginx.exe -v

rem 按照指定配置去启动 Nginx
nginx.exe -c conf/nginx.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>如果是运行在 Linux 下，写一个 shell 脚本，大同小异。</p> <p>其他的停止nginx 方式：</p> <p>ps -ef | grep nginx</p> <p>kill -QUIT 主进程号   ：从容停止Nginx
kill -TERM 主进程号   ：快速停止Nginx
pkill -9 nginx     ：强制停止Nginx</p> <p>./nginx -s quit:此方式停止步骤是待nginx进程处理任务完毕进行停止。</p> <p>./nginx -s stop:此方式相当于先查出nginx进程id再使用kill命令强制杀掉进程。</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/cats1/vuepresshome/edit/main/docs/backend/nginx/README.md" target="_blank" rel="noopener noreferrer">有问题需改善此页面!</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/backend/mongodb/ji-he-guan-li.html" class="prev">
        MongoDB：集合管理
      </a></span> <span class="next"><a href="/backend/nginx/docker.html">
        docker
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.a4743452.js" defer></script><script src="/assets/js/2.b72805e3.js" defer></script><script src="/assets/js/41.649b9d9b.js" defer></script>
  </body>
</html>
